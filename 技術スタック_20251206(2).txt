# アプリケーションのデプロイに関する技術スタックと手順のまとめ (2025/12/06)

## 1. 初期状況と目標

- **目標**: `app.exe` (PyInstallerでビルドされたFlaskアプリケーション) をサーバーにデプロイする。
- **初期分析**:
    - フレームワーク: Python, Flask
    - データベース: SQLite (`history.db`)
    - 特徴: デスクトップ実行を想定した作り（ブラウザ自動起動など）

## 2. デプロイ先の選定と方針

- **プラットフォーム**: **Render** を選択。
    - **理由**: 操作がシンプルで、WebサービスとPostgreSQLデータベースに無料プランがあるため。
- **方針**: 実行ファイル (`.exe`) ではなく、Pythonのソースコード (`.py`) を直接デプロイする。
- **無料プランの主な制約**:
    - **Webサービス**: 30分間アクセスがないとスリープする。
    - **データベース**: 作成から90日でデータが自動的に削除される。

## 3. デプロイに向けたアプリケーションの修正

### a. `requirements.txt` の更新
本番サーバー環境 (gunicorn) とPostgreSQLデータベースに対応させるため、ライブラリを更新。
- **削除**: `waitress`
- **追加**: `gunicorn`, `Flask-SQLAlchemy`, `psycopg2-binary`

### b. `app.py` のリファクタリング
クラウド環境に対応させるため、大幅に修正。
- **データベース**: SQLiteからPostgreSQLへの移行に対応。
    - **`SQLAlchemy`** を導入し、データベース操作をORM (Object-Relational Mapping) に置き換え。
    - Renderが提供する環境変数 `DATABASE_URL` を読み込むように変更。
- **サーバー起動**: アプリケーション起動時に、`db.create_all()` を実行し、データベースのテーブルが自動で作成されるように修正。
- **不要な処理の削除**: サーバー環境では不要なブラウザ自動起動やシャットダウン用のエンドポイントを削除。

### c. `Procfile` の作成
Renderに対して、Webサーバーの起動方法を指示するファイルを作成。
- **内容**: `web: gunicorn app:app`

### d. `static/js/script.js` の修正
フロントエンドのバグ修正。
- **問題**: 画像のDB保存に失敗しても、画面上だけ画像が更新されてしまう。
- **修正**: API呼び出しが失敗した場合、エラーを表示して処理を中断するように修正。

## 4. デプロイとトラブルシューティングの履歴

1. **初回デプロイ**: `Start Command` の設定ミスにより失敗。Renderの設定画面から正しいコマンド (`gunicorn app:app`) に修正して解決。
2. **2回目デプロイ**: APIが500エラーを返す問題が発生。DBテーブルが作成されていなかったことが原因。`app.py` にテーブルを自動作成する処理を追加して解決。
3. **3回目デプロイ**: 画像保存時のUIの挙動に問題が発覚。JavaScriptのエラーハンドリングを修正して解決。
4. **現在**: Gitに変更がコミットされていない問題 (`nothing to commit`) が発生。`git status`での現状確認を依頼中。

---
**使用/導入した主な技術・ツール**:
- **PaaS**: Render
- **Webサーバー**: gunicorn
- **データベース**: PostgreSQL (on Render)
- **Pythonライブラリ**: Flask-SQLAlchemy, psycopg2-binary
- **設定ファイル**: Procfile
---