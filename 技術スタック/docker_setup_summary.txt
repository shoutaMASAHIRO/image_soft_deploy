# Dockerセットアップの復習とまとめ

このドキュメントは、アプリケーションをDockerでローカル実行するまでの一連の作業をまとめたものです。

## 1. 当初の目標と方針転換

- **当初の目標**: PyInstallerで作成された `app.exe` をDockerで実行すること。
- **問題点**: `app.exe` はWindows用の実行ファイルであり、一般的なLinuxベースのDockerコンテナでは直接実行できない。
- **方針転換**: Renderへのデプロイ構成を参考に、Windowsに依存しないPythonソースコード (`app.py`) を直接Dockerコンテナで動かす方針に変更。この方法が、より汎用性が高く、クラウド環境との親和性も高いと判断しました。

## 2. Dockerfileの作成

アプリケーションをDockerイメージ化するために、`image-analysis-app` ディレクトリに `Dockerfile` を作成しました。

```Dockerfile
# ベースとなるPythonの公式イメージを指定
FROM python:3.9-slim

# コンテナ内での作業ディレクトリを設定
WORKDIR /app

# 必要なライブラリをインストールするため、requirements.txtを先にコピー
COPY requirements.txt .

# pipを使ってライブラリをインストール
RUN pip install --no-cache-dir -r requirements.txt

# アプリケーションのソースコードを作業ディレクトリにコピー
COPY . .

# コンテナの8080番ポートを外部に公開する設定
EXPOSE 8080

# ポート番号を環境変数として設定（Dockerfileの警告対応）
ENV PORT=8080

# コンテナ起動時に実行されるコマンドを指定
CMD ["gunicorn", "--bind", "0.0.0.0:8080", "app:app"]
```

### 各命令の解説
- `FROM`: イメージの土台（ベースイメージ）を指定します。
- `WORKDIR`: これ以降の命令が実行されるコンテナ内のディレクトリを定めます。
- `COPY`: ローカルのファイルをコンテナ内にコピーします。
- `RUN`: コマンドを実行します。ここではライブラリをインストールしています。
- `EXPOSE`: コンテナがリッスンするポート番号を外部に知らせます。
- `CMD`: コンテナが起動したときに、デフォルトで実行されるコマンドです。

## 3. Docker実行時のトラブルシューティング

### 問題1: Dockerデーモンへの接続エラー
- **コマンド**: `docker build -t image-analysis-app .`
- **エラー**: `The system cannot find the file specified.`
- **原因**: Dockerコマンドを実行するには、バックグラウンドでDockerエンジン（デーモン）が動作している必要があります。このエラーは、Docker Desktopが起動していないために発生しました。
- **解決策**: Docker Desktopアプリケーションを起動しました。

### 問題2: Docker Desktopが起動しない
- **状況**: `com.docker.build.exe` というプロセスが原因でDocker Desktopの起動が停止しました。
- **原因**: 以前に失敗したビルドプロセスが正常に終了せず、残存していた可能性があります。
- **解決策**: タスクマネージャーから `com.docker.build.exe` プロセスを強制終了させた後、再度Docker Desktopを起動することで解決しました。

## 4. 実行したDockerコマンド

### イメージのビルド
```sh
docker build -t image-analysis-app .
```
- **意味**: カレントディレクトリ（`.`）にある `Dockerfile` を使って、`image-analysis-app` という名前（タグ）のDockerイメージをビルドするコマンドです。
- `-t`: イメージに名前とタグを付ける (`name:tag`) オプションです。

### コンテナの実行
```sh
docker run -p 8080:8080 image-analysis-app
```
- **意味**: `image-analysis-app` イメージを元にコンテナを起動するコマンドです。
- `-p 8080:8080`: ホストPCの`8080`番ポートと、コンテナの`8080`番ポートを繋ぐ（ポートフォワーディング）設定です。これにより、`http://localhost:8080` でコンテナ内のアプリケーションにアクセスできるようになります。
