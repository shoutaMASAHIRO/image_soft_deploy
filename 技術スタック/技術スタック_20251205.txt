# 画像解析ツール改修内容サマリー

**作成日:** 2025年12月5日

## 1. 概要

画像解析ツールの「秤量計算」タブに、過去に入力した化学式の履歴を保存・表示する機能を追加しました。
計算実行時に使用された「生成物の組成式」と「原料の化学式」がデータベースに保存され、次回以降、入力欄からドロップダウン形式で選択できるようになります。

---

## 2. 技術スタック

- **バックエンド**: Python, Flask, Waitress, SQLite
- **フロントエンド**: HTML, CSS (Bootstrap 5), JavaScript

---

## 3. 改修内容詳細

### 3.1. バックエンド (`app.py` の変更点)

今回の機能追加のバックエンド側の主な変更点です。

#### 3.1.1. データベース (SQLite) の導入

- **目的**: 化学式の入力履歴を永続的に保存するため、データベース機能を導入しました。
- **技術選定**: アプリケーションのポータビリティを損なわないよう、外部サーバーが不要でファイルベースで動作する **SQLite** を採用しました。
- **実装**:
    - 実行ファイル (`app.exe`) と同じ階層に `history.db` というデータベースファイルが自動生成されます。
    - アプリケーション起動時に `init_db` 関数が実行され、以下の2つのテーブルがなければ自動的に作成します。
        - `product_formulas`: 生成物の化学式を保存 (`formula` カラムは `UNIQUE` 制約付き)。
        - `reactant_formulas`: 原料の化学式を保存 (`formula` カラムは `UNIQUE` 制約付き)。

#### 3.1.2. APIエンドポイントの追加

フロントエンド（ブラウザ）とデータベースの橋渡しを行うため、以下の2つのAPIエンドポイントをFlaskで実装しました。

- **`GET /api/formulas`**
    - **役割**: データベースに保存されているすべての化学式履歴を取得します。
    - **動作**: `product_formulas` と `reactant_formulas` の両テーブルから全データを取得し、 `{ "products": [...], "reactants": [...] }` という形式のJSONデータとしてフロントエンドに返します。

- **`POST /api/formulas`**
    - **役割**: フロントエンドから送信された新しい化学式をデータベースに保存します。
    - **動作**: 
        - 秤量計算の実行が成功した後、フロントエンドから `{ "product": "...", "reactants": ["...", "..."] }` という形式のJSONデータを受け取ります。
        - `INSERT OR IGNORE` というSQLコマンドを使用し、データベースにまだ存在しない化学式のみを各テーブルに追加します。これにより、履歴の重複を防ぎます。

### 3.2. フロントエンド (`index.html` の変更点)

- **UIの改修**:
    - 「生成物の組成式」と「原料の化学式」の `<input>` タグに `list` 属性を追加しました。
    - 各入力欄に対応する `<datalist>` 要素を配置しました。これにより、入力欄がドロップダウンリストの機能を持つようになります。

### 3.3. フロントエンド (`script.js` の変更点)

- **履歴の読み込みと表示**:
    - ページ読み込み完了時に実行される `loadFormulaHistory` 関数を新規に実装しました。
    - この関数は `GET /api/formulas` を呼び出し、取得したJSONデータを元に `<datalist>` の中身（`<option>`要素）を動的に生成します。

- **履歴の保存**:
    - 計算成功後に新しい履歴を保存する `saveFormulaHistory` 関数を新規に実装しました。
    - `runGenericCalculation`（計算実行）関数の処理の最後に、この関数を呼び出す処理を追加しました。
    - この関数は現在の入力値を取得し、`POST /api/formulas` を呼び出してデータをバックエンドに送信します。保存が成功すると、リストを即時更新するために再度 `loadFormulaHistory` を呼び出します。

### 3.4. 依存関係 (`requirements.txt`)

- プロジェクトの依存関係を正確に記述するため、`app.py` で使用されているWSGIサーバー `waitress` を `requirements.txt` に追記しました。

