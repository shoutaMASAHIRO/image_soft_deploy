# 技術スタックと実装の記録 (2025-12-04)

このドキュメントは、画像解析ツールの開発過程における技術的な仕様、実装、および解説をまとめたものです。

## 1. アプリケーションの基本アーキテクチャ (`app.exe`)

初期段階で実施した性能分析に基づくアーキテクチャの解説です。

*   **基本構造**: バックエンド（サーバー）とフロントエンド（クライアント）が分離した構造です。
    *   **バックエンド (`app.py`)**:
        *   PythonのWebフレームワーク**Flask**と、WSGIサーバー**Waitress**を使用しています。
        *   役割は、起動時に`index.html`などのフロントエンド資産をブラウザに提供することに限定されています。
        *   画像処理などの重い計算は一切行わないため、非常に軽量で高速に動作します。
    *   **フロントエンド (`static/js/script.js`)**:
        *   画像処理（コントラスト調整、粒径測定など）の計算は、すべてユーザーのブラウザ上で**JavaScript**と**Canvas API(内部API：ページ下部で説明)**を用いて実行されます。
        *   サーバーとの通信が不要なため、リアルタイム性の高い操作感を実現しています。
*   **結論**: `app.exe`自体の負荷は極めて低く、アプリケーションの体感性能は、使用するユーザーのPCのCPU性能やブラウザの処理能力に依存します。

## 2. UIのタブ化

操作パネルのUIを改善するために、タブ機能を導入しました。

*   **目的**: 「操作パネル」と新機能「秤量計算」のUIを分離し、切り替え可能にする。
*   **実装**:
    *   `templates/index.html`: UIの骨格として、フロントエンドフレームワーク**Bootstrap**が提供する`nav-tabs`コンポーネントを利用してタブのHTML構造を作成しました。
    *   `static/js/script.js`: タブがクリックされた際に、対応するコンテンツの表示・非表示を切り替えるロジックをJavaScriptで実装しました。具体的には、CSSの`active`クラスと`d-none`クラスを付け替えることで制御しています。

## 3. 秤量計算機能の実装と汎用化 (メジャーアップデート)

当初は固定の化学式のみに対応していた秤量計算機能を、ユーザーが任意の化学式を入力できる汎用的なツールへと大幅にアップグレードしました。

### 3.1. UIの汎用化 (`templates/index.html`)

*   **生成物・原料の入力**: 固定表示だった化学式を、ユーザーが自由に入力できるテキストボックス (`<input type="text">`) に変更しました。
*   **動的な結果表示**: 原料の計算結果を表示するエリアを、JavaScriptによって動的にHTMLが生成されるコンテナ (`<div>`) に変更しました。

### 3.2. 計算ロジックの汎用化 (`static/js/script.js`)

#### a. 原子量データ
*   **課題**: あらゆる元素に対応する必要がある。
*   **解決策**: `script.js`内に、周期表の主要な元素の原子量を網羅した巨大なJavaScriptオブジェクト (`ATOMIC_WEIGHTS`) を定義しました。化学式が入力されると、このオブジェクトから元素記号をキーにして原子量を取得します。
    ```javascript
    const ATOMIC_WEIGHTS = {
        H: 1.008,
        C: 12.011,
        O: 15.999,
        Ca: 40.078,
        // ...
    };
    ```

#### b. 化学式パーサー (Formula Parser)
*   **課題**: `Ca(2-x)Sm(x)MnO4` のような、変数`x`や括弧を含む化学式文字列をプログラムが理解できる形式に変換する必要がある。
*   **解決策**: **正規表現**を用いて、化学式を解析する`parseFormula`関数を実装しました。
    *   使用した正規表現: `/([A-Z][a-z]*)(\([^)]+\)|\d*\.?\d*)?/g`
    *   この正規表現は、「元素記号」と、その直後にある「数字または括弧で囲まれた式」をセットで抽出し、`{元素: 係数, ...}` という形式のオブジェクトを生成します。
*   **技術的解説 (なぜ`x`を`(x)`と囲む必要があるか)**:
    *   上記パーサーの仕様上、係数が単純な数字でない場合（変数`x`や式`2-x`など）、それが係数であることを明示するために**括弧`()`で囲むルール**としています。
    *   `Smx`と入力すると、パーサーは`Sm`という元素しか認識できず、`x`を係数として扱えません。`Sm(x)`とすることで、`x`が`Sm`の係数であると正しく認識されます。

#### c. 係数評価関数 (Coefficient Evaluator)
*   **課題**: `"2-x"` のような文字列の係数を、`x`の実際の値を使って計算する必要がある。
*   **解決策**: `evaluateCoefficient`関数を実装。`eval()`よりも安全な`new Function('x', 'return ' + expressionString)`という手法を用いて、文字列として保存されている係数の式を実際の数値に変換します。

#### d. 動的な化学量論計算
*   **課題**: ユーザーが入力した生成物と原料から、化学反応におけるモル比を自動で決定する必要がある。
*   **解決策**: 新しいメイン計算ロジック (`runGenericCalculation`) では、以下の手順で計算を行います。
    1.  生成物の化学式を解析し、含まれる元素（例: `Ca`）とその量（例: `2-x`）を特定します。
    2.  原料リストの中から、その元素（`Ca`）を供給する原料（例: `CaCO3`）を見つけ出します。
    3.  生成物と原料におけるその元素の量（例: 生成物`Ca(2-x)` vs 原料`Ca1`）を比較し、**モル比**をその場で動的に算出します。
    4.  このモル比を用いて、最終的に必要な各原料の質量を計算します。

---

Canvas
  APIとは、Webブラウザ上でJavaScriptを使ってグラフィックを描画するためのHTML5の標準機能です。HTMLの<ca
  nvas>タグと組み合わせて使用します。

  この画像解析アプリケーションでは、主に以下の目的でCanvas APIを活用しています。

   1. 画像データの読み込みと表示:
      ユーザーがアップロードした画像を、まず<canvas>要素上に描画します。これにより、JavaScriptから画像
      データへのアクセスが可能になります。
   2. 画像処理の実行:
       * 画像のピクセルデータを取得 (getImageData()) します。
       * 取得したピクセルデータ（RGB値など）をJavaScriptで直接操作・計算します。例えば、コントラスト調
         整ではピクセルの輝度値を変更し、鮮明化では周囲のピクセル情報を使ってエッジを強調するなどの処
         理を行います。
       * 処理後のピクセルデータを再びCanvasに書き戻します
         (putImageData())。これにより、編集された画像が画面に表示されます。
   3. オーバーレイ描画:
      寸法測定時の線や点、粒径測定で検出された粒子の輪郭、範囲選択時の矩形など、画像の上に重ねて表示す
      るグラフィックもCanvas APIを使って描画しています。

  つまり、このアプリケーションにおける画像データの操作、分析、そして結果の視覚化のほとんどすべてが、Ja
  vaScriptとCanvas APIの機能によってブラウザ内で完結している、ということになります。


以上の変更により、当初の画像解析ツールは、より広範な化学研究のニーズに対応可能な、柔軟性の高い秤量計算ツールへと進化しました。
