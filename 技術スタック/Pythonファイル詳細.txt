1. ã“ã® Python ãƒ•ã‚¡ã‚¤ãƒ«ã®å½¹å‰²ï¼ˆã–ã£ãã‚Šï¼‰

ä¸€è¨€ã§è¨€ã†ã¨ï¼š

Flask ã‚’ä½¿ã£ã¦

HTML ã‚’è¿”ã™ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ /

åŒ–å­¦å¼å±¥æ­´ç”¨ API /api/formulas

å…ƒç”»åƒä¿å­˜ãƒ»å¾©å…ƒç”¨ API /api/image/save /api/image/load
ã‚’æä¾›ã—ã¤ã¤ã€
ãã®ãƒ‡ãƒ¼ã‚¿ã‚’ SQLite ã¾ãŸã¯ PostgreSQL ã«ä¿å­˜ã™ã‚‹ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰

ã¨ã—ã¦å‹•ã„ã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã€‚

PyInstaller ã§å›ºã‚ãŸ exe ã§ã‚‚ã€ãã®ã¾ã¾ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œã§ã‚‚å‹•ãã‚ˆã†ã«ãƒ‘ã‚¹å‘¨ã‚Šã‚‚å·¥å¤«ã—ã¦ã‚ã‚‹ã€‚

2. å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰ã”ã¨ã® Flask ã‚¢ãƒ—ãƒªè¨­å®šï¼ˆPyInstaller å¯¾å¿œï¼‰
if getattr(sys, 'frozen', False):
    base_dir = sys._MEIPASS
    template_folder = os.path.join(base_dir, 'templates')
    static_folder = os.path.join(base_dir, 'static')
    app = Flask(__name__, template_folder=template_folder, static_folder=static_folder)
else:
    app = Flask(__name__)


PyInstaller ã§ãƒã‚¤ãƒŠãƒªåŒ–ã—ãŸã¨ãï¼ˆsys.frozen == Trueï¼‰

ä¸€æ™‚å±•é–‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª sys._MEIPASS é…ä¸‹ã®
templates / static ã‚’è¦‹ã‚‹ã‚ˆã†ã«è¨­å®š

é€šå¸¸ã® python app.py å®Ÿè¡Œã®ã¨ã

æ™®é€šã® Flask(__name__) ã§èµ·å‹•

ğŸ‘‰ ã€Œãƒ­ãƒ¼ã‚«ãƒ«ã§ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¨ã—ã¦å‹•ã‹ã—ã¦ã‚‚ã€é…å¸ƒç”¨ exe ã«ã—ã¦ã‚‚åŒã˜ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ»é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½¿ãˆã‚‹ã€ã‚ˆã†ã«ã—ã¦ã„ã‚‹ã€‚

3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®šï¼ˆç’°å¢ƒå¤‰æ•°ã§ PostgreSQL / SQLite åˆ‡ã‚Šæ›¿ãˆï¼‰
database_url = os.environ.get('DATABASE_URL')
if database_url:
    if database_url.startswith('postgres://'):
        database_url = database_url.replace('postgres://', 'postgresql://', 1)
    app.config['SQLALCHEMY_DATABASE_URI'] = database_url
else:
    local_db_path = os.path.join(os.path.dirname(os.path.abspath(__file__)), 'history.db')
    app.config['SQLALCHEMY_DATABASE_URI'] = f'sqlite:///{local_db_path}'


DATABASE_URL ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã¨ã
â†’ Render / Heroku ãªã©ã® PostgreSQL ã«æ¥ç¶š

å¤ã„å½¢å¼ postgres:// ã‚’ SQLAlchemy ç”¨ã« postgresql:// ã«å¤‰æ›

DATABASE_URL ãŒãªã„ã¨ã
â†’ åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã® history.db ã‚’ä½¿ã† ãƒ­ãƒ¼ã‚«ãƒ« SQLite

SQLALCHEMY_TRACK_MODIFICATIONS = False ã¯ã€ä¸è¦ãªã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã‚’åˆ‡ã‚‹ãŸã‚ã®ãŠç´„æŸè¨­å®šã€‚

ğŸ‘‰ åŒã˜ã‚³ãƒ¼ãƒ‰ã§ã€Œãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºï¼ˆSQLiteï¼‰ã€ã¨ã€ŒRender æœ¬ç•ªï¼ˆPostgreSQLï¼‰ã€ã‚’åˆ‡ã‚Šæ›¿ãˆå¯èƒ½ãªæ§‹æˆã€‚

4. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ ï¼ˆ3ã¤ã®ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
class ProductFormula(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    formula = db.Column(db.String(255), nullable=False, unique=True)

class ReactantFormula(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    formula = db.Column(db.String(255), nullable=False, unique=True)

class OriginalImage(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    image_data = db.Column(db.LargeBinary, nullable=False)

4-1. product_formula ãƒ†ãƒ¼ãƒ–ãƒ«

ä¸»ã‚­ãƒ¼: id (Integer)

ã‚«ãƒ©ãƒ : formula (æ–‡å­—åˆ—, 255æ–‡å­—, NOT NULL, UNIQUE)

å½¹å‰²: ç”Ÿæˆç‰©ã®åŒ–å­¦å¼ã®å±¥æ­´ã‚’ä¸€æ„ã«ä¿å­˜

4-2. reactant_formula ãƒ†ãƒ¼ãƒ–ãƒ«

ä¸»ã‚­ãƒ¼: id

ã‚«ãƒ©ãƒ : formula (æ–‡å­—åˆ—, 255æ–‡å­—, NOT NULL, UNIQUE)

å½¹å‰²: åŸæ–™ï¼ˆåå¿œç‰©ï¼‰ã®åŒ–å­¦å¼ã®å±¥æ­´ã‚’ä¸€æ„ã«ä¿å­˜

4-3. original_image ãƒ†ãƒ¼ãƒ–ãƒ«

ä¸»ã‚­ãƒ¼: id

ã‚«ãƒ©ãƒ : image_data (LargeBinary / Postgres ãªã‚‰ bytea)

å½¹å‰²:
ã€Œå…ƒç”»åƒã€ã‚’ 1æšã ã‘ ä¿å­˜ã™ã‚‹ãŸã‚ã®ãƒ†ãƒ¼ãƒ–ãƒ«
â†’ ã‚³ãƒ¼ãƒ‰ä¸Šã§ã‚‚ OriginalImage.query.delete() ã—ã¦ã‹ã‚‰ id=1 ã§æ¯å›å…¥ã‚Œç›´ã—ã¦ã„ã‚‹

4-4. ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆã‚¿ã‚¤ãƒŸãƒ³ã‚°
with app.app_context():
    db.create_all()


ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«ã€å®šç¾©æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ã«å¯¾å¿œã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ãŒ å­˜åœ¨ã—ãªã‘ã‚Œã°ä½œæˆã•ã‚Œã‚‹ã€‚

5. API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å½¹å‰²
5-1. åŒ–å­¦å¼å±¥æ­´ API /api/formulas
GET /api/formulas
products = [item.formula for item in ProductFormula.query.order_by(ProductFormula.formula).all()]
reactants = [item.formula for item in ReactantFormula.query.order_by(ReactantFormula.formula).all()]
return jsonify(products=products, reactants=reactants)


product_formula / reactant_formula ã‹ã‚‰
å…¨ã¦ã®åŒ–å­¦å¼ï¼ˆformulaï¼‰ã ã‘ã‚’å–ã‚Šå‡ºã—ã¦æ˜‡é †ã«è¿”ã™

ãƒ•ãƒ­ãƒ³ãƒˆ JS ã®

ã‚µã‚¸ã‚§ã‚¹ãƒˆ / æ¤œç´¢ï¼ˆallProductFormulas, allReactantFormulasï¼‰

<datalist> ã®ä¸­èº«
ã«ä½¿ã‚ã‚Œã‚‹

POST /api/formulas
data = request.get_json()
product_formula = data.get('product')
reactant_formulas = data.get('reactants', [])
...
if product_formula and not ProductFormula.query.filter_by(formula=product_formula).first():
    db.session.add(ProductFormula(formula=product_formula))
...


ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ { product: "...", reactants: ["...", ...] } ã‚’å—ã‘å–ã‚Š

ãƒ†ãƒ¼ãƒ–ãƒ«ã« å­˜åœ¨ã—ãªã„åŒ–å­¦å¼ã ã‘ INSERT

ä¾‹å¤–ç™ºç”Ÿæ™‚ã¯ rollback() ã—ã¦ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹

ğŸ‘‰ ã€Œç§¤é‡è¨ˆç®—ã§ä½¿ã£ãŸåŒ–å­¦å¼ã‚’å±¥æ­´ã¨ã—ã¦ DB ã«è“„ãˆã‚‹ APIã€ã€‚

5-2. ç”»åƒä¿å­˜ API /api/image/save (POST)
OriginalImage.query.delete()
image_binary = base64.b64decode(image_data.split(',')[1])
new_image = OriginalImage(id=1, image_data=image_binary)
db.session.add(new_image)
db.session.commit()


ãƒ•ãƒ­ãƒ³ãƒˆã‹ã‚‰é€ã‚‰ã‚Œã¦ãã‚‹ data:image/png;base64,.... å½¢å¼ã®æ–‡å­—åˆ—ã‚’å—ã‘å–ã‚Šã€

ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’é™¤ã„ã¦ base64 ãƒ‡ã‚³ãƒ¼ãƒ‰

original_image ãƒ†ãƒ¼ãƒ–ãƒ«å†…ã‚’ä¸€æ—¦å…¨éƒ¨å‰Šé™¤

id=1 ã§ä¸€ä»¶ã ã‘ä¿å­˜

ğŸ‘‰ ã€Œæœ€æ–°ã®å…ƒç”»åƒã‚’ä¸€æšã ã‘ DB ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¦ãŠãã€ãŸã‚ã® APIã€‚

5-3. ç”»åƒèª­ã¿å‡ºã— API /api/image/load (GET)
image_record = OriginalImage.query.first()
if image_record:
    image_base64 = base64.b64encode(image_record.image_data).decode('utf-8')
    return jsonify(image_data=f"data:image/png;base64,{image_base64}")
else:
    return jsonify(image_data=None), 404


DB ã‹ã‚‰æœ€åˆã®1ä»¶ï¼ˆï¼å…ƒç”»åƒï¼‰ã‚’å–ã‚Šå‡ºã—ã€å†åº¦ base64 ã«ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰

ãƒ•ãƒ­ãƒ³ãƒˆã« data:image/png;base64,... ã§è¿”ã™

JS å´ã§ <img> ã‚„ <canvas> ã«æç”»ã—ç›´ã™ã“ã¨ã§ã€Œå…ƒã«æˆ»ã™ã€å‡¦ç†ãŒå¯èƒ½ã«ãªã‚‹

5-4. ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ /
@app.route('/')
def index():
    return render_template('index.html')


å˜ç´”ã« templates/index.html ã‚’è¿”ã™ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

ã“ã“ã«ã•ã£ãã®å·¨å¤§ãª JS ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã€ãƒ•ãƒ­ãƒ³ãƒˆå´ã® UI ã¨ãƒ­ã‚¸ãƒƒã‚¯ãŒå‹•ãã€‚

6. é¢æ¥ãƒ»èª¬æ˜ç”¨ã®ã¾ã¨ã‚ãƒ•ãƒ¬ãƒ¼ã‚ºä¾‹
ã‚„ã‚„ãƒ©ã‚¤ãƒˆãªèª¬æ˜

ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¯ Flask ã§è»½é‡ã«æ§‹æˆã—ã¦ã„ã¦ã€
ãƒ­ãƒ¼ã‚«ãƒ«ã§ã¯ SQLiteã€æœ¬ç•ªã® Render ã§ã¯ç’°å¢ƒå¤‰æ•° DATABASE_URL ã«å¿œã˜ã¦ PostgreSQL ã‚’ä½¿ã†ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã¯ã€ç”Ÿæˆç‰©ã¨åŸæ–™ã®åŒ–å­¦å¼å±¥æ­´ã‚’ä¿å­˜ã™ã‚‹ 2ã¤ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã€å…ƒç”»åƒã‚’ 1æšã ã‘ãƒã‚¤ãƒŠãƒªã§ä¿å­˜ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã€åˆè¨ˆ 3ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚
ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã® JavaScript ã‹ã‚‰ã¯ã€/api/formulas ã§å±¥æ­´ã®ä¿å­˜ãƒ»å–å¾—ã€/api/image/save ã¨ /api/image/load ã§å…ƒç”»åƒã®ä¿å­˜ãƒ»å¾©å…ƒã‚’è¡Œã„ã€è¨ˆç®—ã‚„ç”»åƒå‡¦ç†è‡ªä½“ã¯ãƒ–ãƒ©ã‚¦ã‚¶å´ã§å®Œçµã™ã‚‹æ§‹æˆã§ã™ã€‚