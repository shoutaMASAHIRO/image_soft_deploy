# 画像解析ツール 修正ロジックの概要 (2025/12/03)

ここまでの対話で行った、粒径測定アルゴリズムに対する主な修正・改善点の技術的なまとめです。

## 1. 粒径の算出方法の高度化

### 変更前
粒子の外接矩形（四角形）の幅と高さの平均値を、その粒子の「直径」として近似していました。
- `直径 = (幅 + 高さ) / 2`

### 変更後
より正確な直径を算出するため、粒子の実際の面積（ピクセル数）を基準とし、それと同じ面積を持つ**真円の直径**を計算する方法に変更しました。
- `直径 = 2 * √(面積 / π)`

## 2. 重なった粒子の分離と推定

円形ではない粒子（複数の粒子が重なって一つに見える塊）を分離・推定するロジックを実装しました。

### a. 周囲長の計算と円形度の導入
- 粒子を構成するピクセル群の周囲長を計算するロジックを実装しました。
- 計算した面積と周囲長から、その粒子がどれだけ円に近いかを示す「円形度」を算出するようにしました。
  - `円形度 = (4 * π * 面積) / (周囲長の2乗)`
  - 真円の場合、この値は `1.0` になります。

### b. 円形度による粒子の分類
- ユーザーがスライダーで設定した円形度のしきい値を基に、検出されたピクセルの塊を以下の2種類に分類します。
  1. **良好な粒子 (Good Particles):** しきい値以上の円形度を持つ、単一で円形に近い粒子。
  2. **重なった塊 (Merged Blobs):** しきい値未満の円形度を持つ、いびつな形状の粒子。

### c. 重なった塊の個数推定
- 「良好な粒子」の平均面積を基準とします。
- 「重なった塊」の面積をこの平均面積で割ることで、その塊が「およそ何個の粒子から構成されているか」を推定し、最終的な粒子数と平均直径に加算します。

## 3. 外れ値の除去による測定精度の向上

統計的な外れ値除去のロジックを追加しました。

1. 検出された全粒子の直径について、**平均値**と**標準偏差**を算出します。
2. 平均値から「標準偏差の2倍」以上離れている直径を持つ粒子を「外れ値」とみなし、最終的な計算結果から除外します。
3. これにより、極端に大きい、または小さい粒子が全体の平均値に与える影響を低減し、測定結果の信頼性を向上させました。

## 4. UIの改善 (操作性)

- ユーザーがリアルタイムに円形度のしきい値を調整できるよう、操作パネルにスライダーを追加しました。
- スライダーを操作すると、その値が即座に再解析のロジックに反映され、結果が更新されるようになっています。

## 5. バグ修正

- 実装当初、周囲長の計算方法に誤りがあり、円形度が不正な値（`1.0`を超える）になるバグがありました。これを、ピクセルの外周エッジを正確にカウントする方法に修正しました。

## 6. UIの改善 (レイアウト)

操作パネルをスクロールしても、主要な要素が常に画面内に表示されるようにレイアウトを修正しました。

### a. 画像表示エリアの固定
- 画面右側の「元画像 (Before)」と「編集後 (After)」が表示されるエリアに `position: sticky` を適用しました。
- これにより、左側の操作パネルが長くなり、ページを下にスクロールしても、画像は常に画面の上部に固定され、比較しながら操作を続けることができます。

### b. ヘッダーの固定
- ページ最上部の「画像解析ツール」というタイトルが入ったヘッダー（ナビゲーションバー）にも `position: sticky` を適用しました。
- これにより、どの位置にいても常にヘッダーが表示されるようになりました。

# 技術スタックと変更履歴 (2025年12月3日)

## アプリケーション概要
このアプリケーションは、PythonのFlaskとWaitressをバックエンドに持ちますが、主要な画像処理と解析はクライアントサイドのJavaScriptとHTML Canvas APIで行われるウェブベースの画像解析ツールです。画像ファイル（PNG, JPGなど）をアップロードし、コントラスト調整、画像鮮明化、寸法測定、粒径測定、範囲選択（ROI）といった機能を提供します。PyInstallerでバンドルされ、デスクトップアプリケーションとして配布されます。

## 技術スタック
- **バックエンド**: Python (Flask, Waitress)
- **フロントエンド**: HTML, CSS (Bootstrap), JavaScript (Canvas API, DOM操作)
- **画像処理ライブラリ**: JavaScriptのCanvas APIを直接操作。Python側ではPIL (Pillow) がrequirements.txtにあるが、現在の主要な画像解析ロジックはJS側で実装。
- **配布**: PyInstaller

## 2025年12月3日の変更履歴

### 1. 性能分析（最初の要求への回答）
- **内容**: アプリケーションの性能は主にクライアントサイド（ユーザーのブラウザ・PC性能、JSアルゴリズム効率）に依存することを特定。サーバー（Python）は主に静的ファイル配信と簡単なページ表示の役割。

### 2. 機能追加：円形粒子のハイライト
- **内容**: `static/js/script.js` の `drawParticlesOutlines` 関数を変更し、円形度（circularity）の閾値を超える粒子を半透明の赤色で塗りつぶされた円で描画する機能を追加。
- **ファイル**: `static/js/script.js`

### 3. 元に戻す/調整：円形度閾値と赤色塗りつぶし
- **内容**:
    - 赤色塗りつぶし描画を削除し、すべての粒子に対して緑色の矩形アウトラインを描画するように `drawParticlesOutlines` を修正。
    - `analyzeParticlesInRegion` 内の `circularityThreshold` を `1.0` にハードコード。
    - HTML (`templates/index.html`) から `circularitySlider` とその関連テキストを削除し、JavaScript (`static/js/script.js`) から関連するDOM要素選択も削除。
    - `drawParticlesOutlines` を修正し、円形度が `>= 1.0` の粒子のみ緑色の矩形アウトラインで描画するように（厳密な円のみ表示）。
- **ファイル**: `templates/index.html`, `static/js/script.js`

### 4. 修正：粒径測定結果の非決定性
- **内容**: 粒径測定ボタンの連打で結果が変わる問題を解決するため、粒子解析のための画像データ処理フローをリファクタリングし、決定論的な動作を保証。
    - `applyThreshold` 関数を修正し、`ctxAfter` を直接変更する代わりに `ImageData` オブジェクトを引数として受け取り、閾値処理後の `ImageData` を返すように変更。
    - `redrawAfterCanvas` 関数を修正し、処理済み `ImageData` を返し、`particle_size` モードでの閾値処理結果を視覚的に `ctxAfter` に描画するように変更。
    - `analyzeParticlesInRegion` 関数を修正し、処理済み `ImageData` を引数として受け取り、新しい `applyThreshold` 関数を使用するように変更。
    - `analyzeAllParticles` 関数を修正し、`redrawAfterCanvas` から返される処理済み `ImageData` を正しく取得し、`analyzeParticlesInRegion` に渡すように変更。
- **ファイル**: `static/js/script.js`

### 5. 修正：「画像を読み込んでください」ポップアップ問題
- **内容**: 粒径測定中に「画像を読み込んでください」ポップアップが表示される問題を解決。
    - グローバル変数 `currentProcessedImageData` を導入。
    - `analyzeParticlesBtn` クリック時に `redrawAfterCanvas` から返される処理済み `ImageData` を `currentProcessedImageData` に格納。
    - キャンバスのクリックイベントリスナーから `analyzeParticlesInRegion` を呼び出す際に、`currentProcessedImageData` を引数として渡すように修正。
- **ファイル**: `static/js/script.js`

### 6. 調整：表示用アスペクト比フィルタリング
- **内容**: 粒径測定時、緑枠がアスペクト比1に近いもののみ表示されるように調整。
    - グローバル定数 `ASPECT_RATIO_THRESHOLD` (`1.2`) を導入。
    - `drawParticlesOutlines` を修正し、アスペクト比が `ASPECT_RATIO_THRESHOLD` 内にある粒子のみ緑色のアウトラインで描画するように変更。
- **ファイル**: `static/js/script.js`

### 7. 修正：粒子カウントと表示の不一致
- **内容**: `particleCount` が表示される緑枠の数と一致しない問題を解決。
    - `ASPECT_RATIO_THRESHOLD` をグローバル定数としてスクリプトの先頭に定義。
    - `analyzeParticlesInRegion` 内で粒子数と平均値を計算する*前*に、`particles` 配列にアスペクト比フィルタリングを適用するように修正。これにより、カウントと表示される粒子が一致するようにした。
- **ファイル**: `static/js/script.js`