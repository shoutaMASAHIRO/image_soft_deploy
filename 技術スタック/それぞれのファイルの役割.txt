【Pythonファイル】→データ保存・API提供

Webサーバーの本体

Flask を使ってブラウザからのリクエストを受け取る

APIの入り口

/api/formulas や /api/image/save などのURLを定義して、JSONでやりとりする

データベース係

テーブル（ProductFormula, ReactantFormula, OriginalImage）の中身・構造を決める

DBに「保存する」「読み出す」処理をまとめている

ローカル／本番の切り替えスイッチ

SQLite（ローカル）と PostgreSQL（Render）を、環境変数で自動切り替え

アプリの初期化・起動担当

テーブルを作る（db.create_all()）

ローカル開発用に app.run(...) でサーバーを立てる



【JSファイル】→画面の動き・計算・画像処理UIの全部。（外部ライブラリなどは一切用いていない：JS＋Canvas APIでゴリゴリ書いている）

画面全体の初期化係

DOMContentLoaded の中で、ボタン・スライダー・キャンバスなどの DOM 要素を全部取得

モードを contrast から始める / ラベルの初期表示などをセット

秤量計算（化学式まわり）のロジック担当

原子量 ATOMIC_WEIGHTS を持っている

化学式をパースしてモル質量を計算

生成物の量（g or mol）から、必要な原料のモル数・質量を計算して結果を表示

計算後に /api/formulas に POST して履歴をDBに保存する

化学式履歴の読み込み・検索UI

/api/formulas（GET）を叩いて、過去の生成物・原料の式を取得

datalist や検索ボックスに履歴を表示

インクリメンタルサーチ（文字入力で候補を絞る）

矢印キーで候補を選んで Enter でフォームに反映

タブ切り替えとレイアウト制御

サイドバーのタブクリックで、対応するコンテンツを表示/非表示

秤量タブのときは画像表示エリアを隠す、他タブでは表示する

ナビバータイトルの書き換えも担当

画像読み込み & データベース連携

ファイル選択時に FileReader で画像を DataURL に変換

/api/image/save に POST して、元画像をDBに保存

「元に戻す」ボタンで /api/image/load を叩き、保存済み画像を再読み込みしてリセット

キャンバス上の画像処理（フロント側フィルタ）

before/after の2枚キャンバス + オフスクリーンキャンバスで処理

コントラスト調整（シグモイド的 LUT）

シャープフィルタ（3x3カーネルの畳み込み）

スライダー操作に応じてリアルタイムに再描画

距離測定（スケール設定 & 測定ツール）

2点クリックでスケール（px ↔ 実長）をキャリブレーション

その後、任意の2点間距離を実長で表示（px → μmなどに変換）

測定状態・ボタンラベル・表示テキストを全部JSが管理

粒径解析（パーティクル解析）

画像をグレースケール → しきい値処理で2値化

flood fill で連結領域（粒子）をラベリング

面積・周囲長から円相当径・円形度を計算

マージされている塊を分割推定、外れ値除去、アスペクト比フィルタなど

粒子数・平均径(px, 実寸)を表示し、輪郭をキャンバス上に描画

ROI選択 & トリミング機能

ROIモードでドラッグすると赤枠を描画

選択範囲を切り出してモーダルに表示

「この範囲を新しい元画像にする」ボタンで、その範囲を新しい originalImage として再セット

ボタン・スライダー・キャンバスのイベント制御

モード切り替えボタン（コントラスト / シャープ / 測定 / 粒径 / ROI）

しきい値・コントラスト・シャープスライダーの変更に応じてリアルタイム再描画

ダウンロードボタンで、後処理画像を PNG として保存

キャンバスクリックで計測・粒径ROI指定などの動作


----------------------------------------------------------------
なぜフロントエンドで計算できるの？

ブラウザには JavaScriptエンジン（計算する頭脳）が入っている

Chrome → V8

Edge → Chakra 系

これが JS のコードを読み込んで実行している

JavaScript は 普通のプログラミング言語なので：

四則演算

配列・オブジェクト操作

ループ・条件分岐

文字列処理
→ ぜんぶブラウザ内でできる